{% extends "base.html" %}

{% block title %}{{ item.name }} 상세 정보 - {{ company_name }}{% endblock %}

{% block head_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script> 
    <style>
        /* 그래프 크기 제어를 위한 CSS (캔버스 납작 문제 해결) */
        #tempChart {
            max-height: 300px;
            width: 100% !important;
            height: 300px !important;
        }
    </style>
{% endblock %}

{% block content %}
        <div class="card mb-1 shadow-sm">
            <div class="card-header {% if item.status == '오프라인' %}offline-header{% endif %}">
                <div class="label">{{ item.name }}</div>
                <div class="icons">
                    <a href="/" class="card-nav-link">FRONT</a>
                    <a href="{{ url_for('detail_page', device_name=item.device_name) }}" class="card-nav-link">BORD</a>
                    <a href="/settings" class="card-nav-link">SET</a>
                </div>
            </div>
            <div class="card-body">
                <div class="row align-items-center text-center">
                    
                    <div class="col-md-6">
                        <div class="row align-items-end"> 
                            
                            <div class="col-auto"> 
                                <div class="temp display-4 fw-bold {% if item.is_alarm %}warn{% else %}good{% endif %}" id="current-temp">
                                    <span class="temp-value-fix" id="current-temp-value">
                                        {{ '%.1f'|format(item.temperature) if item.temperature is not none else '--.-' }}
                                    </span>
                                    <span class="unit-fixed">°C</span> 
                                </div>
                            </div>
                            
                            <div class="col-auto set-temp-container">
                                <span id="set-temp-value">
                                    {{ '%.1f'|format(item.set_temp) if item.set_temp is not none else '--.-' }}
                                </span>
                                <span class="unit-fixed">°C</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="status text-center mb-3 {% if item.is_alarm %}warn{% else %}good{% endif %}" id="detail-status-text">
                            {% if item.is_alarm %}WAR{% elif item.status == '정상' %}GO{% else %}OFF{% endif %}
                        </div>

                       <div id="op-status" class="d-flex flex-row flex-wrap justify-content-center gap-2">
    
    <span class="badge {{ 'bg-primary' if item.op_status and item.op_status.run else 'bg-light text-dark' }}" style="white-space: nowrap; font-size: 0.8rem;"><i class="fas fa-power-off me-1"></i> 운전</span>
    <span class="badge {{ 'bg-success' if item.op_status and item.op_status.comp else 'bg-light text-dark' }}" style="white-space: nowrap; font-size: 0.8rem;"><i class="fas fa-snowflake me-1"></i> 압축</span>
    <span class="badge {{ 'bg-info text-dark' if item.op_status and item.op_status.defrost else 'bg-light text-dark' }}" style="white-space: nowrap; font-size: 0.8rem;"><i class="fas fa-water me-1"></i> 제상</span>
    <span class="badge {{ 'bg-secondary' if item.op_status and item.op_status.fan else 'bg-light text-dark' }}" style="white-space: nowrap; font-size: 0.8rem;"><i class="fas fa-fan me-1"></i> 팬</span>
</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-1 shadow-sm">
            <div class="card-header">
                온도 이력 그래프
            </div>
            <div class="card-body">
                
                <div class="mb-3"> 
                    <form method="get" class="row g-3 align-items-center justify-content-center">
                        <div class="col-auto d-flex align-items-center">
                            <label for="start_date" class="form-label mb-0 me-2">시작일</label><input type="date" id="start_date" name="start_date" value="{{ start_date }}" class="form-control form-control-sm w-auto"></div>
                        <div class="col-auto d-flex align-items-center">
                            <label for="end_date" class="form-label mb-0 me-2">종료일</label><input type="date" id="end_date" name="end_date" value="{{ end_date }}" class="form-control form-control-sm w-auto"></div>
                        <div class="col-auto"><button type="submit" class="btn btn-secondary btn-sm">조회</button></div>
                    </form>
                </div>
                
                <canvas id="tempChart" style="height: 300px;"></canvas>
                
            </div>
        </div>
        
        <div class="card mb-3 shadow-sm">
            <div class="card-header">
                온도 기록 (30분 간격)
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>시간</th>
                                <th>온도 (°C)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in history_table_data %}
                            <tr>
                                <td>{{ record.timestamp }}</td>
                                <td>{{ '%.1f'|format(record.temperature) }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="2" class="text-center">해당 기간의 데이터가 없습니다.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
{% endblock %}

{% block footer_scripts %}
    <script>
        const historyChartData = {{ history_chart_data_json | safe }}; 
        const setTemp = {{ item.set_temp | tojson }};
        const alarmThreshold = {{ item.alarm_threshold | tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/detail.js') }}"></script>
{% endblock %}